<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical - WhatsApp Medic Scheduler</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .technical-layout {
            display: flex;
            padding-top: 80px;
        }

        .sidebar {
            width: 280px;
            position: fixed;
            left: 0;
            top: 80px;
            background-color: #1a1a2e;
            border-right: 1px solid #16213e;
            height: calc(100vh - 80px);
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #16213e;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 16px;
            color: #e0e0e0;
            font-weight: 600;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            border-bottom: 1px solid #16213e;
        }

        .sidebar-menu li a {
            display: block;
            padding: 12px 20px;
            color: #b0b0b0;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .sidebar-menu li a:hover {
            background-color: #0f3460;
            color: #00d4ff;
            border-left: 3px solid #00d4ff;
            padding-left: 17px;
        }

        .sidebar-menu li a.active {
            background-color: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border-left: 3px solid #00d4ff;
            padding-left: 17px;
        }

        .technical-content {
            flex: 1;
            margin-left: 280px;
            max-width: calc(100% - 280px);
            padding: 40px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 32px;
            margin: 0 0 10px 0;
            color: #e0e0e0;
        }

        .page-header p {
            font-size: 16px;
            color: #b0b0b0;
            margin: 0;
        }

        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            font-size: 24px;
            color: #00d4ff;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #00d4ff;
        }

        .section h3 {
            font-size: 18px;
            color: #e0e0e0;
            margin: 20px 0 10px 0;
        }

        .section p {
            color: #b0b0b0;
            line-height: 1.6;
            margin: 0 0 15px 0;
        }

        .card {
            background-color: #16213e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h4 {
            margin: 0 0 10px 0;
            color: #00d4ff;
        }

        .card p {
            margin: 0;
            color: #b0b0b0;
        }

        .code-block {
            background-color: #0f0f1e;
            border: 1px solid #16213e;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #00ff88;
        }

        .inline-code {
            background-color: #16213e;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #00ff88;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #16213e;
        }

        th {
            background-color: #0f3460;
            color: #00d4ff;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #00d4ff;
        }

        td {
            padding: 12px;
            color: #b0b0b0;
            border-bottom: 1px solid #0f3460;
        }

        tr:hover {
            background-color: #0f3460;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid;
        }

        .alert-info {
            background-color: rgba(0, 212, 255, 0.1);
            border-left-color: #00d4ff;
            color: #00d4ff;
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-left-color: #ffc107;
            color: #ffc107;
        }

        .architecture-diagram {
            background-color: #0f0f1e;
            border: 1px solid #16213e;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            color: #00ff88;
            white-space: pre;
            overflow-x: auto;
            font-size: 12px;
        }

        .component-box {
            background-color: #16213e;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .component-box strong {
            color: #00d4ff;
        }

        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 200;
            background-color: #00d4ff;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            color: #0f0f1e;
            font-size: 18px;
        }

        .menu-toggle:hover {
            background-color: #00a8cc;
        }

        @media (max-width: 968px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .technical-content {
                margin-left: 0;
                max-width: 100%;
                padding: 30px 20px;
            }

            .technical-layout {
                padding-top: 80px;
            }

            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .section h2 {
                font-size: 20px;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp Medic Scheduler</span>
        </div>
        <div class="nav-links">
            <a href="index.html">Início</a>
            <a href="api_reference.html">API Reference</a>
            <a href="ia_agent.html">Agent IA</a>
            <a href="mock_gateway.html">Mock Gateway</a>
            <a href="technical.html" class="active">Technical</a>
            <a href="LGPD/index.html">LGPD</a>
            <a href="Runbook/index.html">Runbook</a>
            <a href="https://github.com/ualers2/WhatsAppMedicSheduler" target="_blank">GitHub</a>
        </div>
    </nav>

    <div class="technical-layout">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Documentação Técnica</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#architecture" class="nav-link active">Arquitetura</a></li>
                <li><a href="#ia-agent" class="nav-link">Agente de IA</a></li>
                <li><a href="#components" class="nav-link">Componentes</a></li>
                <li><a href="#tools" class="nav-link">Ferramentas</a></li>
                <li><a href="#models" class="nav-link">Modelos de Dados</a></li>
                <li><a href="#guardrails" class="nav-link">Guardrails</a></li>
                <li><a href="#data-flow" class="nav-link">Fluxos de Dados</a></li>
                <li><a href="#anomalies" class="nav-link">Anomalias</a></li>
            </ul>
        </aside>

        <main class="technical-content">
            <div class="page-header">
                <h1>Documentação Técnica</h1>
                <p>Detalhes de implementação e arquitetura do WhatsApp Medic Scheduler</p>
            </div>

            <!-- Seção 1: Arquitetura do Sistema -->
            <section class="section" id="architecture">
                <h2><i class="fas fa-sitemap"></i> Arquitetura do Sistema</h2>
                <p>O WhatsApp Medic Scheduler é uma aplicação de agendamento de consultas médicas integrada ao WhatsApp, utilizando uma arquitetura de microserviços com inteligência artificial.</p>

                <h3>Diagrama Arquitetural</h3>
                <div class="architecture-diagram">
┌─────────────────────────────────────────────────────────────────┐
│                     WhatsApp Cloud API                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Webhook Receiver (api.py)                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Recebe mensagens do WhatsApp e valida assinaturas       │   │
│  │ Enfileira processamento de mensagens                    │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────┬─────────────────────────────────────┬──────────┘
                 │                                     │
         ┌───────▼────────┐              ┌─────────────▼────────┐
         │   Message Queue│              │  Database (MongoDB)  │
         │  (Background)  │              │                      │
         └───────┬────────┘              │  - Pacientes        │
                 │                       │  - Convenios        │
                 ▼                       │  - Planos           │
         ┌──────────────────────────────┐  - Appointments      │
         │    Medic Scheduler Agent     │  - Conversations     │
         │  ┌────────────────────────┐  │  - Logs             │
         │  │  LLM (Claude 3.5)      │  │                      │
         │  ├────────────────────────┤  │                      │
         │  │  Tools Executor        │  │                      │
         │  ├────────────────────────┤  │                      │
         │  │  Guardrails Security   │  │                      │
         │  └────────────────────────┘  │                      │
         └──────────────┬───────────────┘                      │
                        │                                     │
         ┌──────────────┴──────────────┐                      │
         │                             │                      │
    ┌────▼────┐  ┌─────────────┐  ┌───▼────────────────────┐│
    │  Tools  │  │ Guardrails  │  │  External Services    ││
    │  ├─────────┤  ├─────────────┤  │  - Vonage SMS         │
    │  │ Get DB  │  │ Safety      │  │  - Patient Service    │
    │  │ Schedule│  │ Compliance  │  │  - Calendar Systems   │
    │  │ Patient │  │ Validation  │  │  - Hospital APIs      │
    │  │ Booking │  └─────────────┘  └─────────────────────┘
    │  └────────┘                                             
    └─────────────────────────────────────────────────────────
                </div>

                <div class="alert alert-info">
                    <strong>Stack Tecnológico:</strong> Python 3.11, FastAPI, MongoDB, Claude 3.5 Sonnet, Docker, Vonage SMS API
                </div>
            </section>

            <!-- Seção 2: Agente de IA -->
            <section class="section" id="ia-agent">
                <h2><i class="fas fa-brain"></i> Agente de IA MedicSheduler</h2>
                <p>O agente central utiliza Claude 3.5 Sonnet com um sistema de pensamento estendido para análise profunda de conversas e decisões.</p>

                <h3>Características Principais</h3>
                <div class="grid-2">
                    <div class="component-box">
                        <strong><i class="fas fa-cogs"></i> Processamento de Mensagens</strong>
                        <p>Análise de mensagens em português com contexto de conversas anteriores</p>
                    </div>
                    <div class="component-box">
                        <strong><i class="fas fa-shield"></i> Validação de Dados</strong>
                        <p>Guardrails de segurança para conformidade LGPD e proteção de dados</p>
                    </div>
                    <div class="component-box">
                        <strong><i class="fas fa-book"></i> RAG (Retrieval Augmented Generation)</strong>
                        <p>Busca contextual em documentos de conhecimento do sistema</p>
                    </div>
                    <div class="component-box">
                        <strong><i class="fas fa-tools"></i> Tool Use</strong>
                        <p>Execução de ferramentas para acesso a dados e operações</p>
                    </div>
                </div>

                <h3>Fluxo de Processamento</h3>
                <div class="code-block">
1. Receber mensagem do WhatsApp
2. Extrair contexto e histórico de conversa
3. Carregar informações do paciente do banco de dados
4. Invocar Agente IA com prompt estruturado
5. Agente analisa requisição e seleciona tools apropriadas
6. Executar tools e validar resultados
7. Gerar resposta conversacional
8. Aplicar guardrails de segurança
9. Enviar resposta ao WhatsApp
10. Registrar interação em log
                </div>

                <div class="alert alert-warning">
                    <strong>Nota:</strong> O agente utiliza extended thinking (beta) do Claude 3.5 para análise mais profunda em cenários complexos.
                </div>
            </section>

            <!-- Seção 3: Componentes Principais -->
            <section class="section" id="components">
                <h2><i class="fas fa-cubes"></i> Componentes Principais</h2>

                <h3>Backend - FastAPI (backend/)</h3>
                <div class="card">
                    <h4><span class="inline-code">api.py</span></h4>
                    <p>Servidor principal que expõe endpoints HTTP para webhooks do WhatsApp e gerenciamento de pacientes.</p>
                </div>

                <div class="card">
                    <h4><span class="inline-code">app/ai.py</span></h4>
                    <p>Implementação do agente de IA com integração ao Claude 3.5 Sonnet.</p>
                </div>

                <div class="card">
                    <h4><span class="inline-code">app/tools.py</span></h4>
                    <p>Definição e implementação de ferramentas disponíveis para o agente de IA.</p>
                </div>

                <div class="card">
                    <h4><span class="inline-code">app/guardrail.py</span></h4>
                    <p>Sistema de proteção e validação de dados com conformidade LGPD.</p>
                </div>

                <h3>Mock Gateway (net_mock_api_gateway/)</h3>
                <p>Simula respostas de APIs externas para testes e desenvolvimento sem dependências externas.</p>

                <h3>Estrutura do App</h3>
                <div class="code-block">
app/
├── __init__.py
├── ai.py              # Agente de IA
├── constants.py       # Constantes da aplicação
├── guardrail.py       # Validações de segurança
├── tools.py           # Ferramentas do agente
├── blueprints/        # Rotas FastAPI
├── keys/              # Chaves de API
├── models/            # Modelos Pydantic
├── schemas/           # Esquemas de dados
├── services/          # Lógica de negócio
└── util/              # Utilitários
                </div>
            </section>

            <!-- Seção 4: Ferramentas (Tools) -->
            <section class="section" id="tools">
                <h2><i class="fas fa-wrench"></i> Ferramentas (Tools)</h2>
                <p>As ferramentas são funções que o agente de IA pode invocar para realizar operações específicas.</p>

                <h3>Ferramentas Disponíveis</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Ferramenta</th>
                            <th>Descrição</th>
                            <th>Retorno</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="inline-code">get_patient_info</span></td>
                            <td>Busca informações completas do paciente</td>
                            <td>Dados do paciente ou erro</td>
                        </tr>
                        <tr>
                            <td><span class="inline-code">schedule_appointment</span></td>
                            <td>Agenda consulta com médico</td>
                            <td>Confirmação de agendamento</td>
                        </tr>
                        <tr>
                            <td><span class="inline-code">check_availability</span></td>
                            <td>Verifica slots disponíveis</td>
                            <td>Lista de horários</td>
                        </tr>
                        <tr>
                            <td><span class="inline-code">get_medical_history</span></td>
                            <td>Recupera histórico médico</td>
                            <td>Dados históricos</td>
                        </tr>
                        <tr>
                            <td><span class="inline-code">search_knowledge_base</span></td>
                            <td>Busca em base de conhecimento</td>
                            <td>Documentos relevantes</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Execução de Tools</h3>
                <div class="code-block">
Tool Execution Flow:
1. Agente seleciona tool baseado em intent do usuário
2. Validar parâmetros com guardrails
3. Executar função correspondente
4. Capturar resultado ou erro
5. Retornar resultado para agente
6. Agente processa resultado e gera resposta
                </div>
            </section>

            <!-- Seção 5: Modelos de Dados -->
            <section class="section" id="models">
                <h2><i class="fas fa-database"></i> Modelos de Dados</h2>
                <p>Estrutura de dados persistida no MongoDB para a aplicação.</p>

                <h3>Paciente (Patient)</h3>
                <div class="code-block">
{
  "_id": ObjectId,
  "phone": "+55119999999",
  "name": "João Silva",
  "email": "joao@email.com",
  "cpf": "12345678900",
  "date_of_birth": "1990-01-15",
  "gender": "M",
  "medical_history": [],
  "allergies": ["Penicilina"],
  "active_medications": [],
  "insurance": {
    "convenio_id": ObjectId,
    "plano_id": ObjectId,
    "registration": "123456"
  },
  "appointments": [ObjectId],
  "created_at": ISODate,
  "updated_at": ISODate
}
                </div>

                <h3>Agendamento (Appointment)</h3>
                <div class="code-block">
{
  "_id": ObjectId,
  "patient_id": ObjectId,
  "doctor_id": ObjectId,
  "specialty": "Cardiologia",
  "scheduled_date": ISODate,
  "duration_minutes": 30,
  "status": "confirmed",
  "notes": "Acompanhamento pós consulta",
  "reminder_sent": false,
  "created_at": ISODate,
  "updated_at": ISODate
}
                </div>

                <h3>Convenio (Insurance)</h3>
                <div class="code-block">
{
  "_id": ObjectId,
  "name": "Unimed",
  "code": "001",
  "active": true,
  "plans": [ObjectId],
  "created_at": ISODate
}
                </div>

                <h3>Conversa (Conversation)</h3>
                <div class="code-block">
{
  "_id": ObjectId,
  "patient_id": ObjectId,
  "messages": [
    {
      "timestamp": ISODate,
      "sender": "user|agent",
      "content": "Olá, preciso agendar uma consulta",
      "metadata": {}
    }
  ],
  "status": "active|closed",
  "created_at": ISODate,
  "updated_at": ISODate
}
                </div>
            </section>

            <!-- Seção 6: Guardrails de Segurança -->
            <section class="section" id="guardrails">
                <h2><i class="fas fa-lock"></i> Guardrails de Segurança</h2>
                <p>Sistema de proteção de dados e conformidade com regulamentações (LGPD, HIPAA).</p>

                <h3>Camadas de Guardrails</h3>
                <div class="grid-2">
                    <div class="component-box">
                        <strong>1. Input Validation</strong>
                        <p>Validação de entrada e sanitização para prevenir injeção de código</p>
                    </div>
                    <div class="component-box">
                        <strong>2. Data Privacy</strong>
                        <p>Mascaramento de dados sensíveis (CPF, emails) em logs e respostas</p>
                    </div>
                    <div class="component-box">
                        <strong>3. Access Control</strong>
                        <p>Verificação de permissões antes de acessar dados de pacientes</p>
                    </div>
                    <div class="component-box">
                        <strong>4. Output Filtering</strong>
                        <p>Filtragem de respostas para remover dados sensíveis antes do envio</p>
                    </div>
                    <div class="component-box">
                        <strong>5. LGPD Compliance</strong>
                        <p>Conformidade com Lei Geral de Proteção de Dados Pessoais</p>
                    </div>
                    <div class="component-box">
                        <strong>6. Audit Logging</strong>
                        <p>Registro detalhado de todas as operações com dados sensíveis</p>
                    </div>
                </div>

                <h3>Implementação em guardrail.py</h3>
                <div class="code-block">
class DataGuardrail:
    - validate_input(data, schema)
    - mask_sensitive_data(data, fields)
    - check_access_permission(user, resource)
    - sanitize_output(response)
    - audit_log(action, user, resource, status)
    - validate_consent(patient_id, operation)
                </div>

                <div class="alert alert-info">
                    <strong>LGPD:</strong> Todos os dados pessoais são tratados com consentimento explícito e os usuários podem solicitar exclusão de dados a qualquer momento.
                </div>
            </section>

            <!-- Seção 7: Fluxos de Dados -->
            <section class="section" id="data-flow">
                <h2><i class="fas fa-stream"></i> Fluxos de Dados</h2>

                <h3>Fluxo de Agendamento</h3>
                <div class="code-block">
Usuário envia mensagem WhatsApp
          ↓
Webhook recebe e valida
          ↓
Extrai contexto de conversa
          ↓
Busca informações do paciente no DB
          ↓
Invoca Agente IA com contexto
          ↓
Agente detecta intent "agendar consulta"
          ↓
Executa tool: check_availability
          ↓
Recupera slots disponíveis
          ↓
Agente apresenta opções em mensagem
          ↓
Usuário seleciona horário
          ↓
Agente confirma e executa schedule_appointment
          ↓
Atualiza banco de dados
          ↓
Envia confirmação ao WhatsApp
          ↓
Registra interação em logs
                </div>

                <h3>Fluxo de Processamento de Mensagem</h3>
                <div class="code-block">
┌─ Webhook (api.py)
│  ├─ Parse JSON do WhatsApp
│  ├─ Verificar assinatura
│  ├─ Extrair phone e message_id
│  └─ Enfileirar para processamento
│
└─ Message Processor (background task)
   ├─ Buscar paciente por phone
   ├─ Carregar histórico de conversa
   ├─ Preparar prompt para IA
   │  ├─ Contexto sistema
   │  ├─ Histórico recente
   │  ├─ Informações do paciente
   │  └─ Tools disponíveis
   ├─ Invocar Claude 3.5 Sonnet
   │  └─ Agente executa pensamento estendido
   ├─ Processar tool calls (se houver)
   │  ├─ Executar cada tool
   │  ├─ Validar com guardrails
   │  └─ Retornar resultados
   ├─ Aplicar guardrails à resposta
   ├─ Enviar para WhatsApp API
   └─ Salvar em histórico de conversa
                </div>

                <h3>Fluxo de Notificações</h3>
                <div class="code-block">
Verificar agendamentos do dia
          ↓
Para cada agendamento sem lembrança:
  - Buscar informações do paciente
  - Gerar mensagem de confirmação
  - Enviar via Vonage SMS ou WhatsApp
  - Marcar como enviado
          ↓
Registrar envios em log
                </div>
            </section>

            <!-- Seção 8: Anomalias Detectadas -->
            <section class="section" id="anomalies">
                <h2><i class="fas fa-exclamation-triangle"></i> Anomalias Detectadas</h2>
                <p>Diferenças e inconsistências identificadas entre a documentação e o código implementado.</p>

                <div class="alert alert-warning">
                    <strong>Importante:</strong> Esta seção documenta discrepâncias que podem impactar a manutenção e o desenvolvimento futuro.
                </div>

                <h3>1. Arquitetura de Tools</h3>
                <div class="card">
                    <h4>Discrepância na Execução de Tools</h4>
                    <p><strong>Documentado:</strong> Tools retornam resultados estruturados que são processados diretamente pelo agente.</p>
                    <p><strong>Código Real:</strong> Alguns tools em <span class="inline-code">app/tools.py</span> retornam respostas formatadas em texto, não estruturadas, o que pode causar inconsistência no processamento.</p>
                    <p><strong>Recomendação:</strong> Padronizar retorno de todas as tools para formato estruturado JSON.</p>
                </div>

                <h3>2. Validação de Dados</h3>
                <div class="card">
                    <h4>Guardrails Parcialmente Implementados</h4>
                    <p><strong>Documentado:</strong> Todos os inputs passam por validação rigorosa com mask de dados sensíveis.</p>
                    <p><strong>Código Real:</strong> <span class="inline-code">guardrail.py</span> existe mas nem todos os endpoints usam suas funções de validação. Alguns dados sensíveis (CPF, email) podem vazar em logs.</p>
                    <p><strong>Recomendação:</strong> Aplicar middleware de guardrail em todas as rotas e verificar logs para vazamentos.</p>
                </div>

                <h3>3. Histórico de Conversas</h3>
                <div class="card">
                    <h4>Persistência Inconsistente</h4>
                    <p><strong>Documentado:</strong> Todo histórico de conversa é salvo no modelo Conversation do MongoDB.</p>
                    <p><strong>Código Real:</strong> Alguns scripts de teste usam armazenamento em memória ou arquivos locais. Production code pode ter race conditions.</p>
                    <p><strong>Recomendação:</strong> Centralizar todas as operações de histórico no banco de dados com transações.</p>
                </div>

                <h3>4. RAG Implementation</h3>
                <div class="card">
                    <h4>Sistema de Busca Não Otimizado</h4>
                    <p><strong>Documentado:</strong> RAG utiliza busca vetorial com embeddings do Claude.</p>
                    <p><strong>Código Real:</strong> Implementação atual usa busca textual simples. Sem embeddings e sem índices de busca vetorial.</p>
                    <p><strong>Recomendação:</strong> Implementar busca vetorial com ChromaDB ou similarmente para melhor relevância.</p>
                </div>

                <h3>5. Error Handling</h3>
                <div class="card">
                    <h4>Tratamento de Erros Incompleto</h4>
                    <p><strong>Documentado:</strong> Todos os erros são capturados e processados com respostas amigáveis ao usuário.</p>
                    <p><strong>Código Real:</strong> Exceções podem não ser capturadas em alguns paths críticos. Agente pode enviar mensagens de erro técnicas ao usuário.</p>
                    <p><strong>Recomendação:</strong> Implementar try-catch wrapper em message processor e traduzir erros técnicos.</p>
                </div>

                <h3>6. Mock Gateway vs Real Services</h3>
                <div class="card">
                    <h4>Inconsistência de Respostas</h4>
                    <p><strong>Documentado:</strong> Mock gateway simula todas as APIs externas com dados realistas.</p>
                    <p><strong>Código Real:</strong> Algumas respostas do mock gateway não correspondem ao contrato esperado das APIs reais (ex: Vonage SMS).</p>
                    <p><strong>Recomendação:</strong> Validar respostas do mock gateway contra documentação oficial das APIs.</p>
                </div>

                <h3>7. Performance e Escalabilidade</h3>
                <div class="card">
                    <h4>Sem Cache Implementado</h4>
                    <p><strong>Documentado:</strong> Sistema otimizado com cache de dados frequentemente acessados.</p>
                    <p><strong>Código Real:</strong> Sem cache Redis ou similar. Cada requisição faz queries repetidas no banco.</p>
                    <p><strong>Recomendação:</strong> Implementar Redis para cache de pacientes e availability slots.</p>
                </div>

                <h3>8. Extended Thinking do Claude</h3>
                <div class="card">
                    <h4>Feature Descrita mas Não Ativa</h4>
                    <p><strong>Documentado:</strong> Agente utiliza extended thinking (beta) para análise profunda.</p>
                    <p><strong>Código Real:</strong> Extended thinking não está ativo no <span class="inline-code">ai.py</span>. Configuração não inicializada na chamada ao Claude.</p>
                    <p><strong>Recomendação:</strong> Ativar extended_thinking na chamada à API quando for GA, com fallback para modo normal.</p>
                </div>

                <div class="alert alert-info">
                    <strong>Next Steps:</strong> Revisar e alinhar código com documentação técnica. Priorizar correção de anomalias críticas de segurança e dados.
                </div>
            </section>

            <hr style="border: 1px solid #0f3460; margin: 50px 0;">

            <div style="text-align: center; color: #b0b0b0; padding: 20px 0;">
                <p>Documentação Técnica - WhatsApp Medic Scheduler</p>
                <p style="font-size: 12px;">Última atualização: Dezembro 2024</p>
            </div>
        </main>
    </div>

    <footer style="background-color: #0f0f1e; border-top: 1px solid #16213e; padding: 20px; text-align: center; color: #b0b0b0; margin-top: 50px;">
        <p>&copy; 2024 WhatsApp Medic Scheduler. Todos os direitos reservados.</p>
    </footer>

    <script>
        // Menu Toggle para Mobile
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Fechar sidebar ao clicar em um link
        const navLinks = document.querySelectorAll('.sidebar-menu a');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                sidebar.classList.remove('active');
            });
        });

        // Highlight de seção ativa ao rolar
        window.addEventListener('scroll', () => {
            let current = '';
            const sections = document.querySelectorAll('.section');

            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (scrollY >= sectionTop - 200) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').slice(1) === current) {
                    link.classList.add('active');
                }
            });
        });

        // Smooth scroll para links internos
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').slice(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Fechar sidebar ao clicar fora
        document.addEventListener('click', (e) => {
            if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>