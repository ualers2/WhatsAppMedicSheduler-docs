<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent IA - WhatsApp Medic Scheduler</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .agent-architecture {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
        }
        .agent-architecture h3 {
            color: #25d366;
            margin-bottom: 20px;
        }
        .arch-diagram {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .arch-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(37,211,102,0.3);
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .arch-box:hover {
            border-color: #25d366;
            transform: translateY(-3px);
        }
        .arch-box i {
            font-size: 24px;
            color: #25d366;
            margin-bottom: 10px;
            display: block;
        }
        .arch-box h4 {
            color: #fff;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .arch-box p {
            color: #888;
            font-size: 12px;
            margin: 0;
        }
        .arch-arrow {
            display: flex;
            align-items: center;
            color: #25d366;
            font-size: 24px;
        }
        .flow-step {
            display: flex;
            align-items: flex-start;
            margin: 15px 0;
            padding: 15px;
            background: rgba(37,211,102,0.05);
            border-left: 3px solid #25d366;
            border-radius: 0 8px 8px 0;
        }
        .flow-step-number {
            background: #25d366;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .flow-step-content h4 {
            color: #fff;
            margin: 0 0 5px 0;
        }
        .flow-step-content p {
            color: #aaa;
            margin: 0;
        }
        .tool-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        .tool-card:hover {
            border-color: rgba(37,211,102,0.5);
            background: rgba(37,211,102,0.03);
        }
        .tool-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .tool-card-header i {
            color: #25d366;
            font-size: 20px;
        }
        .tool-card-header h4 {
            color: #fff;
            margin: 0;
        }
        .guardrail-box {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .guardrail-item {
            flex: 1;
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .guardrail-item.input {
            border-left: 3px solid #f39c12;
        }
        .guardrail-item.output {
            border-left: 3px solid #3498db;
        }
        .guardrail-item h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .guardrail-item.input h4 i { color: #f39c12; }
        .guardrail-item.output h4 i { color: #3498db; }
        @media (max-width: 768px) {
            .guardrail-box { flex-direction: column; }
            .arch-arrow { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation (includes/nav-links.html) -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp Medic Scheduler</span>
        </div>
        <div class="nav-links" id="navLinks">
            <!-- Links loaded from includes/nav-links.html -->
        </div>
    </nav>

    <!-- Page Header -->
    <header class="page-header">
        <h1><i class="fas fa-robot"></i> Agent IA - Documenta√ß√£o Completa</h1>
        <p>Guia t√©cnico do agente de IA para agendamento m√©dico via WhatsApp</p>
    </header>

    <!-- Main Content -->
    <div class="docs-container">
        <!-- Sidebar -->
        <aside class="docs-sidebar">
            <div class="sidebar-section">
                <h4>Vis√£o Geral</h4>
                <ul>
                    <li><a href="#overview">Introdu√ß√£o</a></li>
                    <li><a href="#architecture">Arquitetura</a></li>
                    <li><a href="#lifecycle">Ciclo de Vida</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h4>Configura√ß√£o</h4>
                <ul>
                    <li><a href="#model-settings">Model Settings</a></li>
                    <li><a href="#context">Contexto do Agente</a></li>
                    <li><a href="#session">Sess√£o (SQLite)</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h4>Ferramentas (Tools)</h4>
                <ul>
                    <li><a href="#tool-getdate">GetCurrentDate</a></li>
                    <li><a href="#tool-procedimentos">ListProcedimentos</a></li>
                    <li><a href="#tool-filiais">ListFiliais</a></li>
                    <li><a href="#tool-convenios">ListConvenios</a></li>
                    <li><a href="#tool-planos">ListPlanosConvenio</a></li>
                    <li><a href="#tool-search">SearchSlots</a></li>
                    <li><a href="#tool-unidade">SearchUnidade</a></li>
                    <li><a href="#tool-sala">SearchSala</a></li>
                    <li><a href="#tool-scheduler">OpenBooking</a></li>
                    <li><a href="#tool-fallback">FallbackToHuman</a></li>
                    <li><a href="#tool-rag">RAG Context</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h4>Testes & Valida√ß√£o</h4>
                <ul>
                    <li><a href="#testing-scripts">Scripts de Teste</a></li>
                    <li><a href="#updates-summary">Resumo de Atualiza√ß√µes</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h4>Seguran√ßa</h4>
                <ul>
                    <li><a href="#guardrails">Guardrails</a></li>
                    <li><a href="#system-breakdown">System Breakdown</a></li>
                    <li><a href="#token-management">Token Management</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h4>Fluxos</h4>
                <ul>
                    <li><a href="#flow-agendamento">Fluxo de Agendamento</a></li>
                    <li><a href="#flow-reagendamento">Reagendar/Cancelar</a></li>
                    <li><a href="#flow-errors">Tratamento de Erros</a></li>
                </ul>
            </div>
        </aside>

        <!-- Content -->
        <main class="docs-content">
            <!-- Overview -->
            <section id="overview" class="doc-section">
                <h2><i class="fas fa-info-circle"></i> Introdu√ß√£o</h2>
                <p>O <strong>AgentMedicSheduler</strong> √© um agente de IA conversacional desenvolvido com o framework <strong>OpenAI Agents SDK</strong> para automatizar o agendamento de consultas m√©dicas via WhatsApp.</p>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb"></i>
                    <span><strong>Tecnologias:</strong> OpenAI GPT-5-nano, Agents SDK, SQLite Sessions, ChromaDB RAG, Flask, PostgreSQL</span>
                </div>

                <h3>Caracter√≠sticas Principais</h3>
                <ul>
                    <li><strong>Conversa√ß√£o Natural:</strong> Entende express√µes como "amanh√£", "pr√≥xima segunda", "semana que vem"</li>
                    <li><strong>Contexto Persistente:</strong> Mant√©m hist√≥rico de conversa via SQLiteSession</li>
                    <li><strong>Input/Output Guardrails:</strong> Prote√ß√£o contra inputs maliciosos e vazamento de dados</li>
                    <li><strong>RAG Integration:</strong> Busca contexto em documenta√ß√£o interna via ChromaDB</li>
                    <li><strong>Token Management:</strong> Controle de consumo di√°rio com circuit breaker</li>
                    <li><strong>Fallback Humano:</strong> Transfer√™ncia autom√°tica para atendentes</li>
                </ul>

                <h3>Especifica√ß√µes T√©cnicas</h3>
                <table class="doc-table">
                    <tbody>
                        <tr><td><strong>Nome</strong></td><td>WhatsApp Medic Sheduler</td></tr>
                        <tr><td><strong>Modelo</strong></td><td>gpt-5-nano</td></tr>
                        <tr><td><strong>Max Turns</strong></td><td>20 itera√ß√µes por conversa</td></tr>
                        <tr><td><strong>Session Storage</strong></td><td>SQLite (persistente por usu√°rio)</td></tr>
                        <tr><td><strong>Tracing</strong></td><td>AgentOps (opcional)</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Architecture -->
            <section id="architecture" class="doc-section">
                <h2><i class="fas fa-sitemap"></i> Arquitetura</h2>
                
                <div class="agent-architecture">
                    <h3>Fluxo de Processamento</h3>
                    <div class="arch-diagram">
                        <div class="arch-box">
                            <i class="fab fa-whatsapp"></i>
                            <h4>WhatsApp</h4>
                            <p>Mensagem do Paciente</p>
                        </div>
                        <div class="arch-arrow">‚Üí</div>
                        <div class="arch-box">
                            <i class="fas fa-plug"></i>
                            <h4>Webhook</h4>
                            <p>Twilio/Vonage</p>
                        </div>
                        <div class="arch-arrow">‚Üí</div>
                        <div class="arch-box">
                            <i class="fas fa-shield-alt"></i>
                            <h4>Input Guardrail</h4>
                            <p>Valida√ß√£o Seguran√ßa</p>
                        </div>
                        <div class="arch-arrow">‚Üí</div>
                        <div class="arch-box">
                            <i class="fas fa-robot"></i>
                            <h4>Agent Core</h4>
                            <p>GPT-5-nano</p>
                        </div>
                        <div class="arch-arrow">‚Üí</div>
                        <div class="arch-box">
                            <i class="fas fa-tools"></i>
                            <h4>Tools</h4>
                            <p>Function Calling</p>
                        </div>
                        <div class="arch-arrow">‚Üí</div>
                        <div class="arch-box">
                            <i class="fas fa-shield-alt"></i>
                            <h4>Output Guardrail</h4>
                            <p>Valida√ß√£o Sa√≠da</p>
                        </div>
                        <div class="arch-arrow">‚Üí</div>
                        <div class="arch-box">
                            <i class="fab fa-whatsapp"></i>
                            <h4>Resposta</h4>
                            <p>Envio ao Paciente</p>
                        </div>
                    </div>
                </div>

                <h3>Componentes Principais</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>AgentMedicSheduler - Inicializa√ß√£o</span>
                        <button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i></button>
                    </div>
                    <pre><code class="python">class AgentMedicSheduler:
    def __init__(self, user_number, app): 
        self.app = app
        self._chatkit_guard = create_systembreakdown_server(app)
        self.guard = self.get_guard()
        self.user_number = user_number
        self.session_id = hash_user_number(user_number)
        
        # Sess√£o SQLite persistente por usu√°rio
        self.session = SQLiteSession(
            self.session_id, 
            db_path=f'convthreads/{self.session_id}/{self.session_id[:8]}.db'
        )
        
        # Configura√ß√£o do modelo
        model_settings = ModelSettings(
            include_usage=True,
            workflow_name="WhatsApp Medic Sheduler",
            parallel_tool_calls=False  # Tools executadas sequencialmente
        )
        
        # Defini√ß√£o do Agente
        self.assistant = Agent[MedicShedulerAgentContext]( 
            model="gpt-5-nano",
            name="WhatsApp Medic Sheduler",
            instructions=BASE_INSTRUCTIONS,
            tools=TOOLS,  # 7 ferramentas dispon√≠veis
            model_settings=model_settings,
            input_guardrails=[input_safety_guardrail],
            output_guardrails=[output_safety_guardrail],
        )</code></pre>
                </div>
            </section>

            <!-- Lifecycle -->
            <section id="lifecycle" class="doc-section">
                <h2><i class="fas fa-sync-alt"></i> Ciclo de Vida da Mensagem</h2>
                
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="flow-step-content">
                        <h4>System Breakdown Check</h4>
                        <p>Verifica se o sistema est√° operacional. Se <code>is_system_broken=True</code>, retorna fallback imediato para humano.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="flow-step-content">
                        <h4>Contexto do Paciente</h4>
                        <p>Busca dados do paciente via <code>NetPacsConnector</code> usando o n√∫mero WhatsApp. Preenche <code>MedicShedulerAgentContext</code>.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="flow-step-content">
                        <h4>Input Guardrail</h4>
                        <p>Analisa mensagem de entrada para detectar conte√∫do malicioso, inje√ß√£o de prompt ou tentativas de bypass.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="flow-step-content">
                        <h4>Agent Runner</h4>
                        <p>Executa o agente com <code>max_turns=20</code>. O agente pode chamar ferramentas m√∫ltiplas vezes at√© completar a tarefa.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="flow-step-content">
                        <h4>Output Guardrail</h4>
                        <p>Valida resposta para prevenir exfiltra√ß√£o de dados sens√≠veis (CPF, tokens, dados m√©dicos).</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">6</div>
                    <div class="flow-step-content">
                        <h4>Token Logging</h4>
                        <p>Registra consumo de tokens via <code>SytemBreakDownHooks</code> para controle de custos e circuit breaker.</p>
                    </div>
                </div>
            </section>

            <!-- Model Settings -->
            <section id="model-settings" class="doc-section">
                <h2><i class="fas fa-sliders-h"></i> Model Settings</h2>
                
                <div class="code-block">
                    <div class="code-header">
                        <span>Configura√ß√£o do Modelo</span>
                        <button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i></button>
                    </div>
                    <pre><code class="python">model_settings = ModelSettings(
    include_usage=True,          # Incluir m√©tricas de uso
    workflow_name="WhatsApp Medic Sheduler",
    parallel_tool_calls=False    # Ferramentas em sequ√™ncia
)

run_config = RunConfig(
    tracing_disabled=False,              # Habilitar tracing
    trace_include_sensitive_data=False,  # N√£o logar dados sens√≠veis
    model_settings=model_settings,
)</code></pre>
                </div>

                <table class="doc-table">
                    <thead>
                        <tr><th>Configura√ß√£o</th><th>Valor</th><th>Descri√ß√£o</th></tr>
                    </thead>
                    <tbody>
                        <tr><td><code>parallel_tool_calls</code></td><td>false</td><td>Ferramentas executadas sequencialmente para garantir ordem</td></tr>
                        <tr><td><code>include_usage</code></td><td>true</td><td>Retorna m√©tricas de tokens consumidos</td></tr>
                        <tr><td><code>max_turns</code></td><td>20</td><td>M√°ximo de itera√ß√µes por conversa</td></tr>
                        <tr><td><code>tracing_disabled</code></td><td>false</td><td>Habilita observabilidade via AgentOps</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Context -->
            <section id="context" class="doc-section">
                <h2><i class="fas fa-database"></i> Contexto do Agente</h2>
                
                <p>O <code>MedicShedulerAgentContext</code> armazena todas as informa√ß√µes necess√°rias para o agente processar a conversa:</p>

                <div class="code-block">
                    <div class="code-header">
                        <span>MedicShedulerAgentContext</span>
                        <button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i></button>
                    </div>
                    <pre><code class="python">@dataclass
class MedicShedulerAgentContext:
    """Contexto do agente para agendamento m√©dico."""
    
    request_context: dict[str, Any]  # number_whatsapp, session_id
    sheduler_context: Optional[ShedulerContext] = None

class ShedulerContext(BaseModel):
    """Contexto completo do agendamento."""
    
    basic_patient_info: BasicPatientInfo    # id, name, whatsapp
    sensive_patient_info: SensivePatientInfo  # cpf, rg, email, etc
    accessionNumber: Optional[str] = None
    protocolo: Optional[str] = None
    idHorario: Optional[str] = None</code></pre>
                </div>

                <h3>BasicPatientInfo</h3>
                <table class="params-table">
                    <thead>
                        <tr><th>Campo</th><th>Tipo</th><th>Descri√ß√£o</th></tr>
                    </thead>
                    <tbody>
                        <tr><td><code>id</code></td><td>string</td><td>ID √∫nico do paciente no sistema</td></tr>
                        <tr><td><code>name</code></td><td>string</td><td>Nome completo do paciente</td></tr>
                        <tr><td><code>number_whatsapp</code></td><td>string</td><td>WhatsApp do paciente</td></tr>
                        <tr><td><code>patient_social</code></td><td>string</td><td>Nome social (se houver)</td></tr>
                    </tbody>
                </table>

                <h3>SensivePatientInfo</h3>
                <table class="params-table">
                    <thead>
                        <tr><th>Campo</th><th>Tipo</th><th>Descri√ß√£o</th></tr>
                    </thead>
                    <tbody>
                        <tr><td><code>sex</code></td><td>string</td><td>Sexo (M/F)</td></tr>
                        <tr><td><code>cpf</code></td><td>string</td><td>CPF do paciente</td></tr>
                        <tr><td><code>rg</code></td><td>string</td><td>RG do paciente</td></tr>
                        <tr><td><code>email</code></td><td>string</td><td>E-mail de contato</td></tr>
                        <tr><td><code>altura</code></td><td>string</td><td>Altura em metros</td></tr>
                        <tr><td><code>peso</code></td><td>string</td><td>Peso em kg</td></tr>
                        <tr><td><code>birthdate</code></td><td>string</td><td>Data nascimento (YYYY/MM/DD)</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Session -->
            <section id="session" class="doc-section">
                <h2><i class="fas fa-history"></i> Sess√£o Persistente</h2>
                
                <p>O agente utiliza <strong>SQLiteSession</strong> para manter hist√≥rico de conversa por usu√°rio:</p>

                <div class="code-block">
                    <pre><code class="python"># Cada usu√°rio tem um banco de dados separado
session_id = hash_user_number(user_number)  # SHA256 do telefone
session_db_path = f'convthreads/{session_id}/{session_id[:8]}.db'

self.session = SQLiteSession(
    session_id, 
    db_path=session_db_path
)</code></pre>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-folder"></i>
                    <span><strong>Estrutura:</strong> <code>backend/convthreads/{hash_do_telefone}/{hash[:8]}.db</code></span>
                </div>
            </section>

            <!-- Tools -->
            <section id="tool-getdate" class="doc-section">
                <h2><i class="fas fa-tools"></i> Ferramentas do Agente</h2>
                
                <p>O agente possui <strong>9 ferramentas</strong> para interagir com o sistema. Cada ferramenta √© test√°vel independentemente atrav√©s de scripts standalone localizados em <code>backend/scripts/tools/</code>.</p>
                
                <div class="alert alert-info">
                    <i class="fas fa-flask-vial"></i>
                    <span><strong>Scripts de Teste:</strong> Todos os scripts est√£o dispon√≠veis em <code>backend/scripts/tools/</code> e podem ser executados isoladamente ou via <code>TEST_ALL_TOOLS.py</code> para valida√ß√£o completa. Veja a se√ß√£o "Scripts de Teste" para mais detalhes.</span>
                </div>

                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-calendar-day"></i>
                        <h4>GetCurrentDate</h4>
                    </div>
                    <p>Obt√©m a data e hora atual do servidor para mapear express√µes naturais.</p>
                    
                    <h5>Quando usar:</h5>
                    <ul>
                        <li>Paciente usa "amanh√£", "pr√≥xima segunda", "semana que vem"</li>
                        <li>Valida√ß√£o de janela de 25h para reagendamento/cancelamento</li>
                    </ul>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "timestamp": 1737259200,
  "data_hora_atual": "2025-01-19T14:30:00",
  "data_BR": "19/01/2025",
  "hora": "14:30:00",
  "numero_dia_semana": 6,
  "message": "Data e hora atual: 19/01/2025 √†s 14:30:00"
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-procedimentos" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-stethoscope"></i>
                        <h4>ListProcedimentos</h4>
                    </div>
                    <p>Lista procedimentos m√©dicos dispon√≠veis (consultas, exames, cirurgias).</p>
                    
                    <h5>Par√¢metros:</h5>
                    <table class="params-table">
                        <tr><td><code>filters</code></td><td>dict (opcional)</td><td>Filtros de busca</td></tr>
                        <tr><td><code>limit</code></td><td>int</td><td>Limite de resultados (padr√£o: 100)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "total": 5,
  "data": [
    {"id_procedimento": 1, "nome": "Tomografia Cr√¢nio", "tipo": "EXAME", "price": 450.00, "duracao_procedimento": 30},
    {"id_procedimento": 2, "nome": "Consulta Geral", "tipo": "CONSULTA", "price": 250.00, "duracao_procedimento": 20},
    {"id_procedimento": 3, "nome": "Resson√¢ncia Magn√©tica", "tipo": "EXAME", "price": 800.00, "duracao_procedimento": 45}
  ]
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-convenios" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-id-card"></i>
                        <h4>ListConvenios</h4>
                    </div>
                    <p>Lista conv√™nios (planos de sa√∫de) dispon√≠veis para agendamento.</p>
                    
                    <h5>Par√¢metros:</h5>
                    <table class="params-table">
                        <tr><td><code>filters</code></td><td>dict (opcional)</td><td>Filtros de busca</td></tr>
                        <tr><td><code>limit</code></td><td>int</td><td>Limite de resultados (padr√£o: 100)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "total": 3,
  "data": [
    {"id_convenio": 1, "id_filial": 1, "nome": "Particular", "ativo": true},
    {"id_convenio": 24, "id_filial": 1, "nome": "Unimed", "ativo": true},
    {"id_convenio": 28, "id_filial": 1, "nome": "Amil", "ativo": true}
  ]
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-filiais" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-hospital"></i>
                        <h4>ListFiliais</h4>
                    </div>
                    <p>Lista filiais/unidades de atendimento da rede de sa√∫de dispon√≠veis para agendamento.</p>
                    
                    <h5>Par√¢metros:</h5>
                    <table class="params-table">
                        <tr><td><code>filters</code></td><td>dict (opcional)</td><td>Filtros por cidade ou regi√£o</td></tr>
                        <tr><td><code>limit</code></td><td>int</td><td>Limite de resultados (padr√£o: 100)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "total": 3,
  "data": [
    {"id_filial": 1, "nome": "Unidade Centro", "cidade": "S√£o Paulo", "endereco": "Av. Paulista, 1000"},
    {"id_filial": 2, "nome": "Unidade Zona Leste", "cidade": "S√£o Paulo", "endereco": "Rua A, 500"},
    {"id_filial": 3, "nome": "Unidade Campinas", "cidade": "Campinas", "endereco": "Av. B, 1500"}
  ]
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-planos" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-list-alt"></i>
                        <h4>ListPlanosConvenio</h4>
                    </div>
                    <p>Lista planos dispon√≠veis para um conv√™nio espec√≠fico.</p>
                    
                    <h5>Par√¢metros:</h5>
                    <table class="params-table">
                        <tr><td><code>id_convenio</code></td><td>string</td><td>ID do conv√™nio (obrigat√≥rio)</td></tr>
                        <tr><td><code>limit</code></td><td>int</td><td>Limite de resultados (padr√£o: 100)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "total": 3,
  "id_convenio": "24",
  "data": [
    {"id_plano_convenio": 1, "nome": "Unimed B√°sico", "tipo": "Individual"},
    {"id_plano_convenio": 2, "nome": "Unimed Premium", "tipo": "Individual"},
    {"id_plano_convenio": 3, "nome": "Unimed Empresarial", "tipo": "Empresarial"}
  ]
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-search" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-search"></i>
                        <h4>SearchSlots</h4>
                    </div>
                    <p>Busca hor√°rios dispon√≠veis para agendamento via NetAnimati API.</p>
                    
                    <h5>Par√¢metros (SearchSlotsParams):</h5>
                    <table class="params-table">
                        <tr><td><code>data_busca</code></td><td>string</td><td>Data inicial (DD/MM/YYYY)</td></tr>
                        <tr><td><code>id_convenio</code></td><td>string</td><td>ID do conv√™nio</td></tr>
                        <tr><td><code>id_filial</code></td><td>string</td><td>ID da filial/unidade</td></tr>
                        <tr><td><code>id_plano_convenio</code></td><td>string</td><td>ID do plano do conv√™nio</td></tr>
                        <tr><td><code>id_procedimento</code></td><td>string</td><td>ID do procedimento</td></tr>
                        <tr><td><code>data_final_busca</code></td><td>string</td><td>Data final (opcional)</td></tr>
                        <tr><td><code>id_medico</code></td><td>string</td><td>ID do m√©dico (opcional)</td></tr>
                        <tr><td><code>busca_inteligente</code></td><td>bool</td><td>Busca inteligente (padr√£o: true)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "total": 5,
  "data": [
    {
      "idHorario": null,
      "idEscala": 10277,
      "idMedico": 10,
      "nomeMedico": "Dr. Jo√£o Silva",
      "idSala": 5,
      "nomeSala": "TOMOGRAFIA",
      "idProcedimento": 1,
      "nomeProcedimento": "TOMOGRAFIA CRANIO",
      "dataString": "22/01/2025",
      "horaInicialString": "09:00:00",
      "horaFinalString": "09:30:00",
      "duracaoProcedimento": 30,
      "disponivel": true
    }
  ]
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-scheduler" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-calendar-check"></i>
                        <h4>OpenBooking</h4>
                    </div>
                    <p>Confirma o agendamento de uma consulta/exame no sistema NetAnimati ap√≥s paciente selecionar hor√°rio dispon√≠vel.</p>
                    
                    <h5>Par√¢metros (BookingParams):</h5>
                    <table class="params-table">
                        <tr><td><code>date</code></td><td>string</td><td>Data (YYYY/MM/DD)</td></tr>
                        <tr><td><code>time</code></td><td>string</td><td>Hora (HH:mm:ss)</td></tr>
                        <tr><td><code>idHorario</code></td><td>int</td><td>ID do hor√°rio NetRIS (null = criar slot)</td></tr>
                        <tr><td><code>idEscala</code></td><td>int</td><td>ID da escala m√©dica</td></tr>
                        <tr><td><code>idMedico</code></td><td>int</td><td>ID do m√©dico</td></tr>
                        <tr><td><code>idSala</code></td><td>int</td><td>ID da sala</td></tr>
                        <tr><td><code>horaInicialString</code></td><td>string</td><td>Hora inicial</td></tr>
                        <tr><td><code>duracaoProcedimento</code></td><td>int</td><td>Dura√ß√£o em minutos</td></tr>
                        <tr><td><code>id_convenio</code></td><td>string</td><td>ID do conv√™nio</td></tr>
                        <tr><td><code>id_filial</code></td><td>string</td><td>ID da filial</td></tr>
                        <tr><td><code>id_plano_convenio</code></td><td>string</td><td>ID do plano</td></tr>
                        <tr><td><code>id_procedimento</code></td><td>string</td><td>ID do procedimento</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "message": "Agendamento realizado com sucesso",
  "protocolo": "HUM-20250122-abc123de",
  "accessionNumber": "ACC-12345-20250122"
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-fallback" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-user-friends"></i>
                        <h4>FallbackToHuman</h4>
                    </div>
                    <p>Transfere a conversa para um atendente humano.</p>
                    
                    <h5>Quando usar:</h5>
                    <ul>
                        <li>Reagendamento/Cancelamento com mais de 25 horas</li>
                        <li>Paciente solicita explicitamente</li>
                        <li>Problema t√©cnico n√£o resolv√≠vel</li>
                        <li>Insatisfa√ß√£o persistente</li>
                    </ul>

                    <h5>Par√¢metros (FallbackParams):</h5>
                    <table class="params-table">
                        <tr><td><code>reason</code></td><td>string</td><td>Motivo da transfer√™ncia</td></tr>
                        <tr><td><code>summary</code></td><td>string</td><td>Resumo da conversa (opcional)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "ticket_id": "HUM-20250122143022-abc123de",
  "message": "Estamos te redirecionando para um atendimento humano."
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-rag" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-brain"></i>
                        <h4>retrieve_documentation_context</h4>
                    </div>
                    <p>Busca contexto relevante na documenta√ß√£o interna via RAG (ChromaDB).</p>
                    
                    <h5>Par√¢metros:</h5>
                    <table class="params-table">
                        <tr><td><code>query</code></td><td>string</td><td>Pergunta ou termo de busca</td></tr>
                        <tr><td><code>k</code></td><td>int</td><td>N√∫mero de resultados (1-10)</td></tr>
                    </table>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span><strong>Importante:</strong> Esta ferramenta deve ser chamada PRIMEIRO em toda conversa para carregar regras e tom de voz da rede de sa√∫de.</span>
                    </div>
                </div>
            </section>

            <section id="tool-unidade" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-info-circle"></i>
                        <h4>SearchUnidade</h4>
                    </div>
                    <p>Busca informa√ß√µes detalhadas de uma unidade/filial espec√≠fica.</p>
                    
                    <h5>Par√¢metros:</h5>
                    <table class="params-table">
                        <tr><td><code>id_unidade</code></td><td>string</td><td>ID da unidade (obrigat√≥rio)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "data": {
    "id_unidade": "1",
    "nome": "Unidade Centro",
    "endereco": "Av. Paulista, 1000",
    "telefone": "(11) 3000-0000",
    "email": "centro@hospital.com.br",
    "horario_atendimento": "Seg-Sex: 08:00-20:00, Sab: 09:00-14:00"
  }
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="tool-sala" class="doc-section">
                <div class="tool-card">
                    <div class="tool-card-header">
                        <i class="fas fa-door-open"></i>
                        <h4>SearchSala</h4>
                    </div>
                    <p>Busca informa√ß√µes detalhadas de uma sala/consult√≥rio espec√≠fico.</p>
                    
                    <h5>Par√¢metros:</h5>
                    <table class="params-table">
                        <tr><td><code>id_sala</code></td><td>string</td><td>ID da sala (obrigat√≥rio)</td></tr>
                    </table>

                    <div class="code-block">
                        <pre><code class="json">{
  "status": "success",
  "data": {
    "id_sala": "5",
    "nome": "Sala Tomografia",
    "id_unidade": "1",
    "id_filial": "1",
    "tipo_atendimento": "Diagn√≥stico por Imagem",
    "equipamentos": ["Tom√≥grafo 128 canais", "Sala de controle"]
  }
}</code></pre>
                    </div>
                </div>
            </section>

            <!-- Scripts de Teste -->
            <section id="testing-scripts" class="doc-section">
                <h2><i class="fas fa-flask-vial"></i> Scripts de Teste</h2>
                
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <span><strong>‚ú® NOVO:</strong> 11 scripts de teste criados para validar cada ferramenta independentemente! Localizados em <code>backend/scripts/tools/</code></span>
                </div>

                <p>Todos os scripts de teste est√£o localizados em <code>backend/scripts/tools/</code> e podem ser executados de forma independente para validar cada ferramenta:</p>

                <h3>Scripts Dispon√≠veis</h3>
                <table class="doc-table">
                    <thead>
                        <tr><th>Script</th><th>Ferramenta</th><th>Prop√≥sito</th><th>Localiza√ß√£o</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>GetCurrentDate.py</code></td>
                            <td>GetCurrentDate</td>
                            <td>Obter data/hora atual para c√°lculos</td>
                            <td><code>backend/scripts/tools/GetCurrentDate.py</code></td>
                        </tr>
                        <tr>
                            <td><code>ListProcedimentos.py</code></td>
                            <td>ListProcedimentos</td>
                            <td>Listar procedimentos m√©dicos</td>
                            <td><code>backend/scripts/tools/ListProcedimentos.py</code></td>
                        </tr>
                        <tr>
                            <td><code>ListFiliais.py</code></td>
                            <td>ListFiliais</td>
                            <td>Listar unidades de atendimento</td>
                            <td><code>backend/scripts/tools/ListFiliais.py</code></td>
                        </tr>
                        <tr>
                            <td><code>ListConvenios.py</code></td>
                            <td>ListConvenios</td>
                            <td>Listar planos de sa√∫de</td>
                            <td><code>backend/scripts/tools/ListConvenios.py</code></td>
                        </tr>
                        <tr>
                            <td><code>ListPlanosConvenio.py</code></td>
                            <td>ListPlanosConvenio</td>
                            <td>Listar planos de um conv√™nio</td>
                            <td><code>backend/scripts/tools/ListPlanosConvenio.py</code></td>
                        </tr>
                        <tr>
                            <td><code>SearchSlots.py</code></td>
                            <td>SearchSlots</td>
                            <td>Buscar hor√°rios dispon√≠veis</td>
                            <td><code>backend/scripts/tools/SearchSlots.py</code></td>
                        </tr>
                        <tr>
                            <td><code>SearchUnidade.py</code></td>
                            <td>SearchUnidade</td>
                            <td>Buscar informa√ß√µes de unidade</td>
                            <td><code>backend/scripts/tools/SearchUnidade.py</code></td>
                        </tr>
                        <tr>
                            <td><code>SearchSala.py</code></td>
                            <td>SearchSala</td>
                            <td>Buscar informa√ß√µes de sala</td>
                            <td><code>backend/scripts/tools/SearchSala.py</code></td>
                        </tr>
                        <tr>
                            <td><code>OpenBooking.py</code></td>
                            <td>OpenBooking</td>
                            <td>Criar agendamento</td>
                            <td><code>backend/scripts/tools/OpenBooking.py</code></td>
                        </tr>
                        <tr>
                            <td><code>FallbackToHuman.py</code></td>
                            <td>FallbackToHuman</td>
                            <td>Transferir para atendente</td>
                            <td><code>backend/scripts/tools/FallbackToHuman.py</code></td>
                        </tr>
                        <tr>
                            <td><code>RetrieveDocumentationContext.py</code></td>
                            <td>retrieve_documentation_context</td>
                            <td>Buscar contexto via RAG</td>
                            <td><code>backend/scripts/tools/RetrieveDocumentationContext.py</code></td>
                        </tr>
                        <tr>
                            <td><code>TEST_ALL_TOOLS.py</code></td>
                            <td>Valida√ß√£o Completa</td>
                            <td>Testar todas as 9 ferramentas sequencialmente</td>
                            <td><code>backend/scripts/tools/TEST_ALL_TOOLS.py</code></td>
                        </tr>
                    </tbody>
                </table>

                <h3>Como Usar</h3>
                
                <h4>1. Testar uma Ferramenta Espec√≠fica</h4>
                <div class="code-block">
                    <div class="code-header">Terminal</div>
                    <pre><code class="bash">cd WhatsAppMedicSheduler
python backend/scripts/tools/ListProcedimentos.py</code></pre>
                </div>

                <h4>2. Validar Todas as Ferramentas (Recomendado)</h4>
                <div class="code-block">
                    <div class="code-header">Terminal</div>
                    <pre><code class="bash">cd WhatsAppMedicSheduler
python backend/scripts/tools/TEST_ALL_TOOLS.py</code></pre>
                </div>

                <div class="code-block">
                    <div class="code-header">Output Esperado (100% de Sucesso)</div>
                    <pre><code class="text">üß™ TESTE DE TODAS AS TOOLS
[1/11] GetCurrentDate...              ‚úì SUCESSO
[2/11] ListProcedimentos...           ‚úì SUCESSO
[3/11] ListFiliais...                 ‚úì SUCESSO
[4/11] ListConvenios...               ‚úì SUCESSO
[5/11] ListPlanosConvenio...          ‚úì SUCESSO
[6/11] SearchSlots...                 ‚úì SUCESSO
[7/11] SearchUnidade...               ‚úì SUCESSO
[8/11] SearchSala...                  ‚úì SUCESSO
[9/11] FallbackToHuman...             ‚úì SUCESSO
[10/11] RetrieveDocumentation...      ‚úì SUCESSO
[11/11] OpenBooking...                ‚úì SUCESSO

‚úì Testes aprovados: 11
‚úó Testes falhados: 0
üìà Taxa de sucesso: 100.0%

‚ú® TODOS OS TESTES PASSARAM COM SUCESSO!</code></pre>
                </div>

                <h4>3. Testar via Docker (Recomendado para Produ√ß√£o)</h4>
                <div class="code-block">
                    <div class="code-header">Terminal</div>
                    <pre><code class="bash"># Iniciar container
docker-compose up webhooks_medicsheduler

# Em outro terminal, executar teste
docker-compose exec webhooks_medicsheduler python backend/scripts/tools/TEST_ALL_TOOLS.py</code></pre>
                </div>

                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <span><strong>Nota:</strong> Os scripts funcionam com ambiente MOCK (padr√£o, sem depend√™ncias externas) ou podem ser configurados para Sandbox/Production via <code>.env</code>.</span>
                </div>

                <h3>Documenta√ß√£o T√©cnica Completa</h3>
                <p>Para documenta√ß√£o detalhada sobre como executar, parametrizar e configurar cada script, consulte:</p>
                <ul>
                    <li>üìñ <code>backend/scripts/tools/README.md</code> - Guia completo de uso</li>
                    <li>‚öôÔ∏è <code>.env.example</code> - Configura√ß√µes dispon√≠veis</li>
                    <li>üîß <code>backend/app/services/connectors/netpacs_connector.py</code> - Implementa√ß√£o do connector</li>
                </ul>
            </section>

            <!-- Guardrails -->
            <section id="guardrails" class="doc-section">
                <h2><i class="fas fa-shield-alt"></i> Guardrails</h2>
                
                <p>O agente possui duas camadas de seguran√ßa para proteger contra inputs maliciosos e vazamento de dados:</p>

                <div class="guardrail-box">
                    <div class="guardrail-item input">
                        <h4><i class="fas fa-sign-in-alt"></i> Input Guardrail</h4>
                        <p>Analisa mensagens de entrada antes de processar.</p>
                        
                        <h5>Detecta:</h5>
                        <ul>
                            <li>Inje√ß√£o de prompt</li>
                            <li>Tentativas de bypass</li>
                            <li>Conte√∫do malicioso</li>
                            <li>Comandos suspeitos</li>
                        </ul>

                        <div class="code-block">
                            <pre><code class="python">class InputSafetyOutput(BaseModel):
    is_malicious: bool
    reason: Optional[str] = None
    reasoning: Optional[str] = None
    matches: Optional[List[str]] = []
    action: Optional[str] = None  # allow, block_and_alert, sanitize_and_warn</code></pre>
                        </div>
                    </div>

                    <div class="guardrail-item output">
                        <h4><i class="fas fa-sign-out-alt"></i> Output Guardrail</h4>
                        <p>Valida respostas antes de enviar ao paciente.</p>
                        
                        <h5>Previne:</h5>
                        <ul>
                            <li>Exfiltra√ß√£o de dados sens√≠veis</li>
                            <li>Vazamento de CPF/RG</li>
                            <li>Exposi√ß√£o de tokens</li>
                            <li>Dados m√©dicos indevidos</li>
                        </ul>

                        <div class="code-block">
                            <pre><code class="python">class OutputSafetyOutput(BaseModel):
    is_exfiltration: bool
    reason: Optional[str] = None
    reasoning: Optional[str] = None
    response: Optional[str] = None
    redacted_output: Optional[str] = None
    matches: Optional[List[str]] = []</code></pre>
                        </div>
                    </div>
                </div>

                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Se um guardrail √© acionado (<code>tripwire_triggered=True</code>), a conversa √© interrompida e retorna <code>False</code>.</span>
                </div>
            </section>

            <!-- System Breakdown -->
            <section id="system-breakdown" class="doc-section">
                <h2><i class="fas fa-heartbeat"></i> System Breakdown</h2>
                
                <p>Sistema de circuit breaker que monitora consumo de tokens e pode desligar o agente automaticamente:</p>

                <div class="code-block">
                    <div class="code-header">
                        <span>SytemBreakDown - Estados do Sistema</span>
                    </div>
                    <pre><code class="python">class Sytem(BaseModel):
    working_hours: List[str]          # Hor√°rios de funcionamento
    last_time_checked: datetime       # √öltima verifica√ß√£o
    is_email_sent: bool               # Alerta enviado?
    the_system_is_broken: bool        # Sistema desligado?
    tokens_info: TokensInfo           # Informa√ß√µes de tokens

class TokensInfo(BaseModel):
    tokens_used: int = 0              # Tokens consumidos hoje
    tokens_limit: int = 100000        # Limite di√°rio
    max_tokens_limit: int = 500000    # Limite m√°ximo
    users_using: int = 0              # Usu√°rios ativos
    users_ids: List[str] = []         # IDs dos usu√°rios</code></pre>
                </div>

                <h3>Verifica√ß√£o Autom√°tica</h3>
                <p>O <code>SytemBreakDown</code> executa verifica√ß√µes peri√≥dicas via APScheduler:</p>
                <ul>
                    <li>Verifica consumo de tokens a cada <code>CHECK_INTERVAL_SECONDS</code></li>
                    <li>Se <code>tokens_used > tokens_limit</code>: envia email de alerta</li>
                    <li>Se <code>tokens_used > max_tokens_limit</code>: define <code>the_system_is_broken=True</code></li>
                    <li>Sistema quebrado ‚Üí todas as mensagens v√£o para fallback humano</li>
                </ul>
            </section>

            <!-- Token Management -->
            <section id="token-management" class="doc-section">
                <h2><i class="fas fa-coins"></i> Token Management</h2>
                
                <p>O consumo de tokens √© registrado via <code>SytemBreakDownHooks</code>:</p>

                <div class="code-block">
                    <pre><code class="python">class SytemBreakDownHooks(RunHooks):
    async def on_agent_end(self, context: RunContextWrapper, agent: Agent, output: Any):
        u = context.usage
        total_tokens = u.total_tokens
        
        # Registra no PostgreSQL
        with self.app.app_context():
            cr = ChatRequest(
                user_id=user_identifier, 
                tokens_used=total_tokens
            )
            db.session.add(cr)
            db.session.commit()</code></pre>
                </div>

                <h3>M√©tricas de Uso</h3>
                <table class="doc-table">
                    <thead>
                        <tr><th>M√©trica</th><th>Descri√ß√£o</th></tr>
                    </thead>
                    <tbody>
                        <tr><td><code>input_tokens</code></td><td>Tokens da mensagem de entrada</td></tr>
                        <tr><td><code>cached_tokens</code></td><td>Tokens em cache (prompt caching)</td></tr>
                        <tr><td><code>reasoning_tokens</code></td><td>Tokens de racioc√≠nio do modelo</td></tr>
                        <tr><td><code>output_tokens</code></td><td>Tokens da resposta gerada</td></tr>
                        <tr><td><code>total_tokens</code></td><td>Total consumido na intera√ß√£o</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Fluxo de Agendamento -->
            <section id="flow-agendamento" class="doc-section">
                <h2><i class="fas fa-route"></i> Fluxo de Agendamento</h2>
                
                <p>O agente segue um fluxo obrigat√≥rio de 6 passos para agendamento:</p>

                <div class="flow-step">
                    <div class="flow-step-number">0</div>
                    <div class="flow-step-content">
                        <h4>retrieve_documentation_context</h4>
                        <p>Carregar regras, tom de voz e personalidade da rede de sa√∫de via RAG.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="flow-step-content">
                        <h4>ListConvenios()</h4>
                        <p>Perguntar qual conv√™nio o paciente vai utilizar. Armazenar <code>id_convenio</code> e <code>id_filial</code>.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="flow-step-content">
                        <h4>ListPlanosConvenio(id_convenio)</h4>
                        <p>Perguntar qual plano do conv√™nio. Armazenar <code>id_plano_convenio</code>.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="flow-step-content">
                        <h4>Perguntar Data</h4>
                        <p><strong>Cr√≠tico:</strong> Perguntar "Para quando voc√™ gostaria?" ANTES de buscar hor√°rios.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="flow-step-content">
                        <h4>GetCurrentDate() + SearchSlots()</h4>
                        <p>Se express√£o natural ("amanh√£"), calcular data. Buscar hor√°rios dispon√≠veis.</p>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="flow-step-content">
                        <h4>OpenBooking()</h4>
                        <p>Confirmar agendamento imediatamente ap√≥s paciente escolher hor√°rio. Retorna protocolo de agendamento.</p>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-ban"></i>
                    <span><strong>Proibido:</strong> Pular etapas, buscar hor√°rios sem conv√™nio/plano, mostrar IDs ao paciente, pedir confirma√ß√£o extra.</span>
                </div>
            </section>

            <!-- Fluxo Reagendamento -->
            <section id="flow-reagendamento" class="doc-section">
                <h2><i class="fas fa-exchange-alt"></i> Reagendar/Cancelar</h2>
                
                <p>A API n√£o suporta reagendamento/cancelamento direto. Todas as solicita√ß√µes passam por valida√ß√£o de 25 horas:</p>

                <div class="code-block">
                    <div class="code-header">
                        <span>L√≥gica de Valida√ß√£o</span>
                    </div>
                    <pre><code class="plaintext">1. GetCurrentDate() ‚Üí Data/hora atual

2. Calcular: Diferen√ßa = (Data da Consulta) - (Data Atual)

3. SE diferen√ßa < 25 horas:
   ‚îî‚îÄ N√ÉO executar ferramenta
   ‚îî‚îÄ Informar: "Nossa equipe entrar√° em contato em at√© 24h"

4. SE diferen√ßa > 25 horas:
   ‚îî‚îÄ Executar: FallbackToHuman(reason="Reagendamento com +25h")
   ‚îî‚îÄ Informar: "Vou transferir para nossa equipe"</code></pre>
                </div>
            </section>

            <!-- Tratamento de Erros -->
            <section id="flow-errors" class="doc-section">
                <h2><i class="fas fa-exclamation-triangle"></i> Tratamento de Erros</h2>
                
                <h3>Guardrail Triggered</h3>
                <div class="code-block">
                    <pre><code class="python">except InputGuardrailTripwireTriggered as e:
    logger.warning(f"Input guardrail triggered - blocked")
    return 0, False  # Tokens=0, Output=False

except OutputGuardrailTripwireTriggered as e:
    logger.warning(f"Output guardrail triggered - blocked")
    return 0, False</code></pre>
                </div>

                <h3>System Broken</h3>
                <div class="code-block">
                    <pre><code class="python">is_system_broken = self.guard.is_system_broken()
if is_system_broken:
    logger.info("Sistema quebrado, fallback para humano")
    return 0, False  # Todas as mensagens v√£o para humano</code></pre>
                </div>

                <h3>Erros de Ferramentas</h3>
                <p>Cada ferramenta retorna <code>{"status": "error", "message": "...", "error": "..."}</code> em caso de falha. O agente deve informar o paciente e tentar alternativas.</p>
            </section>

        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; 2025 WhatsApp Medic Scheduler. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="js/main.js"></script>
</body>
</html>
